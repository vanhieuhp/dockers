<VirtualHost *:81>
    ServerName media.test.prism.horse
    ServerAlias media.test.prism.horse

    ProxyRequests Off
    ProxyPreserveHost On
    ProxyTimeout 2400
    proxyBadheader Ignore
    RewriteEngine on

    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>

    # Rewrite to S3
    RewriteCond %{REQUEST_URI} ^/media/(.*)$
    RewriteRule "^/media/(.*)" "https://prismhorse-test.s3.amazonaws.com/media/$1" [R,L]

    RewriteCond %{REQUEST_URI} ^/assets/(.*)$
    RewriteRule "^/assets/(.*)" "https://prismhorse-test.s3.amazonaws.com/assets/$1" [R,L]

    RewriteEngine on
    RewriteCond %{REQUEST_URI} ^/$ [OR]
    RewriteCond %{REQUEST_URI} ^$
    RewriteRule ^ http://test.prism.horse/ [R,L]

    ProxyPass /api/public http://test.prism.horse/api/public/ retry=0  timeout=60
    ProxyPassReverse /api/public/ http://test.prism.horse/api/public/
</VirtualHost>

<VirtualHost *:80>
    ServerName test.prism.horse
    ServerAlias test.prism.horse
    Redirect Permanent / https://test.prism.horse/
</VirtualHost>

<VirtualHost *:443>
    ServerName test.prism.horse
    ServerAlias test.prism.horse
    ServerAdmin thanh.tran@fruitful.io

    BrowserMatch "MSIE [2-6]" nokeepalive ssl-unclean-shutdown downgrade-1.0 force-response-1.0
    BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

    DocumentRoot "/var/www/prism-frontend"

    <Directory "/var/www/prism-frontend">
        Options +Indexes +FollowSymLinks +MultiViews
        DirectoryIndex  index.html index.php
        AllowOverride None
        Order Allow,deny
        Allow from All

        RewriteEngine on

        # Don't rewrite files or directories
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]

        # Rewrite everything else to index.html to allow html5 state links
        RewriteCond %{REQUEST_URI} ^/portal
        RewriteRule ^ portal/index.html [L]

        # Rewrite everything else to index.html to allow html5 state links
        RewriteRule ^ index.html [L]
    </Directory>

    <Files "apple-app-site-association">
        Header set Content-Type "application/json"
    </Files>

    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>

    SSLEngine on
    SSLCertificateFile      /etc/letsencrypt/live/test.prism.horse/fullchain.pem
    SSLCertificateKeyFile   /etc/letsencrypt/live/test.prism.horse/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/test.prism.horse/chain.pem

    SSLProxyEngine On

    ProxyRequests Off
    ProxyPreserveHost On
    ProxyTimeout 2400
    proxyBadheader Ignore

    RequestHeader set CLIENT_ID "xVgEbwJNuMuFN8SeFblVQGN11Ed0VHmG_"
    RequestHeader set origin "https://test.prism.horse"

    <Location "/portal/help">
    	Header set Content-Security-Policy: "script-src 'nonce-XqomZs9u9vbEEgdE5THYkA=='"
    </Location>

    ####### UPLOAD / PUBLIC / IMPORT MOVED TO UNICORN #######
    ProxyPass /api/public/status http://192.168.4.73:8080/api/public/status retry=0  timeout=60
    ProxyPassReverse /api/public/status http://192.168.4.73:8080/api/public/status

    ProxyPass /api/public/contact http://192.168.4.73:8080/api/public/contact retry=0  timeout=60
    ProxyPassReverse /api/public/contact http://192.168.4.73:8080/api/public/contact

    ProxyPass /api/public/captcha/contact http://192.168.4.73:8080/api/public/captcha/contact retry=0  timeout=60
    ProxyPassReverse /api/public/captcha/contact http://192.168.4.73:8080/api/public/captcha/contact

    ProxyPass /api/cmr http://192.168.4.73:8585/api/cmr retry=0  timeout=60
    ProxyPassReverse /api/cmr http://192.168.4.73:8585/api/cmr
	
    ProxyPass /api/ponny http://192.168.4.73:9990/api/ponny retry=0  timeout=60
    ProxyPassReverse /api/ponny http://192.168.4.73:9990/api/ponny
    
    ProxyPass /api/salesforce http://192.168.4.73:9090/api/salesforce retry=0  timeout=60
    ProxyPassReverse /api/salesforce http://192.168.4.73:9090/api/salesforce

    ProxyPass /api/public http://192.168.4.73:9090/api/public retry=0  timeout=61
    ProxyPassReverse /api/public http://192.168.4.73:9090/api/public
     
    ProxyPass /api/admin/import http://192.168.4.73:9090/api/admin/import retry=0  timeout=60
    ProxyPassReverse /api/admin/import http://192.168.4.73:9090/api/admin/import
     
    ProxyPass /api/upload http://192.168.4.73:9090/api/upload retry=0  timeout=60
    ProxyPassReverse /api/upload http://192.168.4.73:9090/api/upload
    
    ProxyPass /api/media/upload http://192.168.4.73:9090/api/media/upload retry=0  timeout=60
    ProxyPassReverse /api/media/upload http://192.168.4.73:9090/api/media/upload

    ProxyPass /api/workplace http://192.168.4.41:9933/workplace retry=0  timeout=60
    ProxyPassReverse /api/workplace http://192.168.4.41:9933/workplace

    ####### OTHER APIS STILL AT PRISM #######

    ProxyPass /api http://192.168.4.73:8080/api retry=0  timeout=120
    ProxyPassReverse /api http://192.168.4.73:8080/api
    
    ProxyPass /stomp wss://192.168.4.73:15671/ws retry=0  timeout=30
    ProxyPassReverse /stomp wss://192.168.4.73:15671/ws

 #   ProxyPass /prism http://192.168.4.74:8080/prism retry=0  timeout=120
 #   ProxyPassReverse /prism http://192.168.4.74:8080/prism

    ###### KEEP PORTAL ######
    ProxyPass /portal !
    ProxyPass /robots.txt !

    ###### NEW PRISM WEB NEXT ######
    ProxyPass / http://192.168.5.33:6008/
    ProxyPassReverse / http://192.168.5.33:6008/

    LogLevel info
    ErrorLog "/var/log/apache2/test.prismtechnic.com/error.log"
    CustomLog "/var/log/apache2/test.prismtechnic.com/access.log" combined
</VirtualHost>
