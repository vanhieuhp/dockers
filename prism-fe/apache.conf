<VirtualHost *:80>
    ServerName localhost
    ServerAlias localhost
    ServerAdmin thanh.tran@fruitful.io

    BrowserMatch "MSIE [2-6]" nokeepalive ssl-unclean-shutdown downgrade-1.0 force-response-1.0
    BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

    DocumentRoot "/var/www/html"

    <Directory "/var/www/html">
        Options +Indexes +FollowSymLinks +MultiViews
        DirectoryIndex  index.html index.php
        AllowOverride None
        Order Allow,deny
        Allow from All

        RewriteEngine on

        # Don't rewrite files or directories
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]

        # # Rewrite everything else to index.html to allow html5 state links
        RewriteCond %{REQUEST_URI} ^/portal
        RewriteRule ^ portal/index.html [L]

        # Rewrite everything else to index.html to allow html5 state links
        RewriteRule ^ index.html [L]
    </Directory>

    <Files "apple-app-site-association">
        Header set Content-Type "application/json"
    </Files>

    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>

    ProxyRequests Off
    ProxyPreserveHost On
    ProxyTimeout 2400
    proxyBadheader Ignore

    RequestHeader set CLIENT_ID "xVgEbwJNuMuFN8SeFblVQGN11Ed0VHmG_"
    RequestHeader set origin "https://test.prism.horse"

    <Location "/portal/help">
    	Header set Content-Security-Policy: "script-src 'nonce-XqomZs9u9vbEEgdE5THYkA=='"
    </Location>

    ####### UPLOAD / PUBLIC / IMPORT MOVED TO UNICORN #######
    ProxyPass /api/public/status ${MAIN_SERVICE}/api/public/status retry=0  timeout=60
    ProxyPassReverse /api/public/status ${MAIN_SERVICE}/api/public/status

    ProxyPass /api/public/contact ${MAIN_SERVICE}/api/public/contact retry=0  timeout=60
    ProxyPassReverse /api/public/contact ${MAIN_SERVICE}/api/public/contact

    ProxyPass /api/public/captcha/contact ${MAIN_SERVICE}/api/public/captcha/contact retry=0  timeout=60
    ProxyPassReverse /api/public/captcha/contact ${MAIN_SERVICE}/api/public/captcha/contact

    ProxyPass /api/cmr http://192.168.4.73:8585/api/cmr retry=0  timeout=60
    ProxyPassReverse /api/cmr http://192.168.4.73:8585/api/cmr
	
    ProxyPass /api/ponny http://192.168.4.73:9990/api/ponny retry=0  timeout=60
    ProxyPassReverse /api/ponny http://192.168.4.73:9990/api/ponny
    
    ProxyPass /api/salesforce ${UNICORN_SERVICE}/api/salesforce retry=0  timeout=60
    ProxyPassReverse /api/salesforce ${UNICORN_SERVICE}/api/salesforce

    ProxyPass /api/public ${UNICORN_SERVICE}/api/public retry=0  timeout=61
    ProxyPassReverse /api/public ${UNICORN_SERVICE}/api/public
     
    ProxyPass /api/admin/import ${UNICORN_SERVICE}/api/admin/import retry=0  timeout=60
    ProxyPassReverse /api/admin/import ${UNICORN_SERVICE}/api/admin/import
     
    ProxyPass /api/upload ${UNICORN_SERVICE}/api/upload retry=0  timeout=60
    ProxyPassReverse /api/upload ${UNICORN_SERVICE}/api/upload
    
    ProxyPass /api/media/upload ${UNICORN_SERVICE}/api/media/upload retry=0  timeout=60
    ProxyPassReverse /api/media/upload ${UNICORN_SERVICE}/api/media/upload

    ProxyPass /api/workplace http://192.168.4.41:9933/workplace retry=0  timeout=60
    ProxyPassReverse /api/workplace http://192.168.4.41:9933/workplace

    ####### OTHER APIS STILL AT PRISM #######

    ProxyPass /api ${MAIN_SERVICE}/api retry=0  timeout=120
    ProxyPassReverse /api ${MAIN_SERVICE}/api
    
    # ProxyPass /stomp ws://rabbitmq:15671/ws retry=0  timeout=30
    # ProxyPassReverse /stomp ws://rabbitmq:15671/ws

 #   ProxyPass /prism http://192.168.4.74:8080/prism retry=0  timeout=120
 #   ProxyPassReverse /prism http://192.168.4.74:8080/prism

    ###### KEEP PORTAL ######
    ProxyPass /portal !
    ProxyPass /robots.txt !

    ###### NEW PRISM WEB NEXT ######
    # ProxyPass / http://192.168.5.33:6008/
    # ProxyPassReverse / http://192.168.5.33:6008/

    LogLevel info
    ErrorLog "/var/log/apache2/error.log"
    CustomLog "/var/log/apache2/access.log" combined
</VirtualHost>
